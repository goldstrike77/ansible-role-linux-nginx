---
- name: Include OS-specific variables
  include_vars: '{{ ansible_os_family }}.yml'

- name: Include tasks for specific OS
  include: '{{ ansible_os_family }}.yml'

- name: Configure the NGinx firewall
  include: 'firewall.yml'

- name: Straight to getenforce selinux status
  include: 'selinux.yml'

- name: Generate strong Diffieâ€“Hellman key exchange
  include: 'dhparam.yml'
  when: ngx_dhparam

- name: Creating NGinx main folder
  file:
    dest: '{{ item }}'
    state: directory
    owner: '{{ ngx_arg.user }}'
    group: '{{ ngx_arg.user }}'
    mode: 0755
  with_items:
    - '{{ ngx_logs_path }}'
    - '{{ ngx_site_path }}'

- name: Creating NGinx site folder
  file:
    dest: '{{ ngx_site_path }}/{{ item }}'
    state: directory
    owner: '{{ ngx_arg.user }}'
    group: '{{ ngx_arg.user }}'
    mode: 0755
  with_items:
    - '{{ ngx_domain_name }}'

- name: NGinx PKI file transfer
  copy:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    owner: '{{ item.owner }}'
    group: '{{ item.group }}'
    mode: 0644
  with_items:
    - { src: 'ssl/', dest: '{{ ngx_conf_path }}/ssl', owner: 'root', group: 'root' }
  register: pki_update

- name: NGinx main configuration file transfer
  template:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    owner: root
    group: root
    mode: 0644
  with_items:
    - '{{ nginx_conf_scripts }}'
  register: conf_update

- name: NGinx site configuration file transfer
  template:
    src: 'site.conf.j2'
    dest: '{{ ngx_conf_path }}/conf.d/{{ item }}.conf'
    owner: root
    group: root
    mode: 0644
  with_items:
    - '{{ ngx_domain_name }}'
  register: site_update

- name: NGinx site example file transfer
  copy:
    src: 'html/'
    dest: '{{ ngx_site_path }}/{{ item }}'
    owner: '{{ ngx_arg.user }}'
    group: '{{ ngx_arg.user }}'
    mode: 0644
  with_items:
    - '{{ ngx_domain_name }}'

- name: Reload the service
  shell: echo ''
  notify: 'Reloading the Nginx service'
  when: pki_update.changed or conf_update.changed or site_update.changed

- name: Force the handler to run immediately
  meta: flush_handlers

- name: Include prometheus exporter tasks
  include: 'exporter.yml'
