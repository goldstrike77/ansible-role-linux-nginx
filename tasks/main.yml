---
- name: Include OS-specific variables
  include_vars: '{{ ansible_os_family }}.yml'

- name: Include tasks for specific OS
  include: '{{ ansible_os_family }}.yml'

- name: Generate strong Diffieâ€“Hellman key exchange
  include: 'dhparam.yml'

- name: Creating NGinx folder
  file:
    dest: '{{ item }}'
    state: directory
    owner: '{{ ngx_user }}'
    group: '{{ ngx_user }}'
    mode: 0755
  with_items:
    - '{{ ngx_logs_path }}'
    - '{{ ngx_site_path }}'

- name: NGinx system file transfer
  copy:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    owner: '{{ item.owner }}'
    group: '{{ item.group }}'
    mode: 0644
  with_items:
    - { src: 'ssl/', dest: '{{ ngx_conf_path }}/ssl', owner: 'root', group: 'root' }
    - { src: 'html/', dest: '{{ ngx_site_path }}', owner: '{{ ngx_user }}', group: '{{ ngx_user }}' }
  register: soft_updated

- name: NGinx configuration file transfer
  template:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    owner: root
    group: root
    mode: 0644
  with_items:
    - { src: 'nginx.logrotate.j2', dest: '/etc/logrotate.d/nginx' }
    - { src: 'nginx.conf.j2',      dest: '{{ ngx_conf_path }}/nginx.conf' }
    - { src: 'default.conf.j2',    dest: '{{ ngx_conf_path }}/conf.d/default.conf' }
    - { src: 'nginx.service.j2',   dest: '/lib/systemd/system/nginx.service' }
  register: soft_config

- name: Reload the service
  shell: echo ''
  notify: 'Reloading the Nginx service'
  when: soft_updated.changed or soft_config.changed

- name: Force the handler to run immediately
  meta: flush_handlers
