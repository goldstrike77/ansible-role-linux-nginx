#
server {
  listen 80 default_server;
  server_name {{ ngx_domain_name }};
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  resolver {{ ngx_resolver_dns }} valid=300s;
  resolver_timeout 5s;
  server_name {{ ngx_domain_name }};
  ssl_certificate         ssl/certificate.pem;
  ssl_certificate_key     ssl/server.key;
  ssl_dhparam             ssl/dhparam.pem;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:50m;
  ssl_session_ticket_key  ssl/session_ticket.key;
  ssl_session_tickets on;
  ssl_session_timeout 60m;
  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_trusted_certificate ssl/certificate.pem;
{% if ngx_ssl_protocols == 'intermediate' %}
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';
{% elif ngx_ssl_protocols == 'modern' %}
  ssl_protocols TLSv1.2;
  ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
{% else %}
{% endif %}

  charset {{ ngx_charset }};
  root {{ ngx_site_path }};
  index index.html;

{% if ngx_block_spam %}
  # Block spam #
  if ($query_string ~ "\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo|erections|hoodia|huronriveracres|impotence|levitra|libido|ambien|blue\spill|cialis|cocaine|ejaculation|erectile|lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\b") { return 403; }
{% endif %}

{% if ngx_block_agents %}
  # Block user agents #
  if ($http_user_agent ~ "java|python|perl|ruby|curl|bash|echo|uname|base64|decode|md5sum|select|concat|httprequest|httpclient|nmap|scan|wget|libwww-perl|GetRight|GetWeb|Go!Zilla|Download Demon|Go-Ahead-Got-It|TurnitinBot|GrabNet" ) { return 403; }
{% endif %}

{% if ngx_block_common_exploits %}
  # Block common exploits #
  if ($query_string ~ "(<|%3C).*script.*(>|%3E)|GLOBALS(=|\[|\%[0-9A-Z]{0,2})|_REQUEST(=|\[|\%[0-9A-Z]{0,2})|proc/self/environ|mosConfig_[a-zA-Z_]{1,21}(=|\%3D)|base64_(en|de)code\(.*\)") { return 403; }
{% endif %}

{% if ngx_block_file_inject %}
  # Block file injections #
  if ($query_string ~ "[a-zA-Z0-9_]=http://|[a-zA-Z0-9_]=(\.\.//?)+|[a-zA-Z0-9_]=/([a-z0-9_.]//?)+") { return 403; }
{% endif %}

{% if ngx_block_sql_inject %}
  # Block SQL injections #
  if ($query_string ~ "union.*select.*\(|union.*all.*select.*|concat.*\(") { return 403; }
{% endif %}

  # Block unallowed HTTP methods
  if ($request_method !~* '{{ "|".join(vars["ngx_allow-methods"]) }}') { return 405; }

  access_log {{ ngx_logs_path }}/access.log main;
  error_log {{ ngx_logs_path }}/error.log notice;
  access_log syslog:server={{ ngx_syslog_server }}:{{ ngx_acc_syslog_port }} syslog;
  error_log syslog:server={{ ngx_syslog_server }}:{{ ngx_err_syslog_port }};
  
  location = /favicon.ico { access_log off; log_not_found off; }
  location = /robots.txt { access_log off; log_not_found off; }
  location /ErrorPages/ { alias {{ ngx_site_path }}/ErrorPages/; access_log off; log_not_found off; }

  location /nginx_status {
    stub_status on;
    allow 127.0.0.1;
    access_log off;
    deny all;
  }

  # FastCGI Example Configuration #
  #location ~ \.php$ {
  #  expires -1;
  #  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  #  fastcgi_pass backend;
  #  include fastcgi_params;
  #  index index.php; 
  #}

  # Proxy Example Configuration #
  #location ~ \.jsp$ {
  #  expires -1;
  #  proxy_pass backend;
  #}
}

# Back-end Example Configuration #
#upstream backend {
#  server 127.0.0.1:9000 max_fails=3 fail_timeout=20s;
#}
